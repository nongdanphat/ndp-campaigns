<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nông Dân Phát</title>
  <style>
    :root {
      --bg: #f3f4f6; --card: #ffffff; --primary: #15803d; --danger: #b91c1c; --muted: #6b7280;
      --radius: 16px; --shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
    }
    body { margin: 0; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background: var(--bg); color: #0f172a; }
    .page { max-width: 720px; margin: 0 auto; padding: 1rem 1rem 3rem; }
    .hero { background: linear-gradient(135deg, #ecfdf3 0%, #ffffff 100%); border-radius: 20px; padding: 1rem; margin: 1rem 0; display: flex; gap: 1rem; align-items: center; }
    .hero img { width: 90px; height: 90px; border-radius: 14px; object-fit: cover; }
    .hero-title { font-weight: 700; font-size: 1.1rem; margin-bottom: 0.25rem; }
    .hero-desc { color: #475569; font-size: 0.875rem; margin: 0; }
    .card { background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow); padding: 1.25rem; }
    .form-title { font-weight: 600; margin: 1rem 0 0.5rem; }
    .field { margin-bottom: 0.75rem; }
    .field label { display: block; font-weight: 500; margin-bottom: 0.25rem; }
    input, select { width: 100%; padding: 0.55rem 0.6rem; border: 1px solid #e2e8f0; border-radius: 12px; font-size: 0.9rem; outline: none; box-sizing: border-box; transition: all 0.2s; }
    input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(21, 128, 61, 0.12); }
    input.error, select.error { border-color: var(--danger); background: #fee2e2; }
    label.error-label { color: var(--danger); font-weight: 600; }
    button { background: var(--primary); color: white; border: none; border-radius: 999px; padding: 0.6rem 1rem; font-weight: 600; width: 100%; cursor: pointer; transition: background 0.3s; margin-top: 1rem; }
    button:hover { background: #166534; }
    button:disabled { opacity: 0.7; cursor: not-allowed; }
    .status { margin-top: 0.6rem; font-size: 0.8rem; min-height: 1.25rem; }
    .spinner { width: 14px; height: 14px; border: 2px solid rgba(255, 255, 255, 0.4); border-top-color: #fff; border-radius: 999px; animation: spin 0.6s linear infinite; display: inline-block; margin-right: 0.5rem; }
    @keyframes spin { to { transform: rotate(360deg); } }
    @media (max-width: 640px) { .hero img { display: none; } }
  </style>
</head>
<body>
  <div class="page" id="app">
    <div class="hero">
      <img id="campaignImage" src="" alt="Chiến dịch">
      <div>
        <div class="hero-title" id="campaignTitle"></div>
        <p class="hero-desc" id="campaignDesc"></p>
      </div>
    </div>

    <div class="card">
      <div id="formContainer">
        <!-- Form sẽ được sinh tự động -->
      </div>
      <button id="submitBtn"><span id="submitText">Gửi thông tin</span></button>
      <div id="status" class="status"></div>
    </div>
  </div>

  <script>
    // === CẤU HÌNH CHUNG ===
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxj9DexjXxk2uKc8Whn7FdhWA_aj4Sp4MwDibwJjws47NqgWmsco-0SfES0BubuOYTC/exec';
    const urlPath = window.location.pathname;
    const slug = urlPath.split('/').filter(Boolean).pop() || 'c01';

    let config = null;
    let adminData = null;

    // === LOAD CONFIG + DATA ===
    Promise.all([
      fetch(`config/${slug}.json`).then(r => r.ok ? r.json() : Promise.reject('Not found')),
      fetch('admin-data.json').then(r => r.json())
    ])
    .then(([cfg, admin]) => {
      config = cfg;
      adminData = admin;

      const now = new Date();
      const start = new Date(config.start_date);
      const end = new Date(config.end_date + 'T23:59:59');

      if (!config.active || now < start || now > end) {
        showError(`Chiến dịch đã kết thúc hoặc chưa bắt đầu.<br>Thời gian: ${config.start_date} → ${config.end_date}`);
        return;
      }

      document.title = config.title + ' | Nông Dân Phát';
      document.getElementById('campaignTitle').textContent = config.title;
      document.getElementById('campaignDesc').innerHTML = config.description;
      document.getElementById('campaignImage').src = config.image;

      renderForm();
    })
    .catch(err => {
      showError('Không tìm thấy chiến dịch. Vui lòng kiểm tra lại đường dẫn.');
    });

    function showError(msg) {
      document.getElementById('app').innerHTML = `
        <div class="card" style="text-align:center; padding:2rem;">
          <p style="color:#b91c1c; font-weight:600;">${msg}</p>
          <p><a href="/" style="color:var(--primary)">← Quay lại trang chủ</a></p>
        </div>
      `;
    }

    function renderForm() {
      const container = document.getElementById('formContainer');

      const basicFields = [
        { id: 'full_name', label: 'Họ và tên *', type: 'text', required: true },
        { id: 'phone', label: 'Số điện thoại *', type: 'tel', required: true },
        { id: 'province', label: 'Tỉnh / Thành phố *', type: 'select', required: true },
        { id: 'district', label: 'Huyện / Thị xã *', type: 'select', required: true },
        { id: 'ward', label: 'Xã / Phường *', type: 'select', required: true },
        { id: 'hamlet', label: 'Thôn / Ấp / Tổ *', type: 'text', required: true }
      ];

      [...basicFields, ...(config.extra_fields || [])].forEach(field => {
        const div = document.createElement('div');
        div.className = 'field';

        if (field.type === 'select' && field.options) {
          let options = '<option value="">-- Chọn --</option>';
          field.options.forEach(opt => {
            options += `<option value="${opt}">${opt}</option>`;
          });
          div.innerHTML = `<label for="${field.id}">${field.label}</label><select id="${field.id}" ${field.required ? 'required' : ''}>${options}</select>`;
        } else {
          div.innerHTML = `<label for="${field.id}">${field.label}</label><input type="${field.type}" id="${field.id}" placeholder="${field.placeholder || ''}" ${field.required ? 'required' : ''}>`;
        }
        container.appendChild(div);
      });

      setupAddress();
      setupSubmit();
    }

    function setupAddress() {
      const provinceEl = document.getElementById('province');
      const districtEl = document.getElementById('district');
      const wardEl = document.getElementById('ward');

      const districtsByProvince = {};
      const wardsByDistrict = {};

      adminData.forEach(p => {
        districtsByProvince[p.code] = p.districts || [];
        (p.districts || []).forEach(d => {
          wardsByDistrict[d.code] = d.wards || [];
        });
      });

      adminData.forEach(p => {
        const opt = new Option(p.name, p.code);
        provinceEl.add(opt);
      });

      provinceEl.addEventListener('change', () => {
        const districts = districtsByProvince[provinceEl.value] || [];
        districtEl.innerHTML = '<option value="">-- Chọn --</option>';
        districts.forEach(d => {
          const opt = new Option(d.name, d.code);
          districtEl.add(opt);
        });
        wardEl.innerHTML = '<option value="">-- Chọn --</option>';
      });

      districtEl.addEventListener('change', () => {
        const wards = wardsByDistrict[districtEl.value] || [];
        wardEl.innerHTML = '<option value="">-- Chọn --</option>';
        wards.forEach(w => {
          const opt = new Option(w.name, w.code);
          wardEl.add(opt);
        });
      });
    }

    function findName(arr, code) {
      return (arr || []).find(x => String(x.code) === String(code))?.name || '';
    }

    function setupSubmit() {
      const submitBtn = document.getElementById('submitBtn');
      const submitText = document.getElementById('submitText');
      const statusEl = document.getElementById('status');

      submitBtn.addEventListener('click', async () => {
        const required = document.querySelectorAll('[required]');
        let valid = true;
        required.forEach(el => {
          if (!el.value.trim()) {
            el.classList.add('error');
            el.previousElementSibling.classList.add('error-label');
            valid = false;
          } else {
            el.classList.remove('error');
            el.previousElementSibling.classList.remove('error-label');
          }
        });

        if (!valid) {
          statusEl.style.color = '#b91c1c';
          statusEl.textContent = 'Vui lòng điền đầy đủ các trường bắt buộc.';
          return;
        }

        const province = findName(adminData, document.getElementById('province').value);
        const district = findName([], document.getElementById('district').value); // sẽ được xử lý ở backend nếu cần
        const ward = findName([], document.getElementById('ward').value);

        const extra = {};
        (config.extra_fields || []).forEach(f => {
          const el = document.getElementById(f.id);
          if (el) extra[f.id] = el.value;
        });

        const data = {
          campaign_id: config.campaign_id,
          full_name: document.getElementById('full_name').value.trim(),
          phone: document.getElementById('phone').value.trim(),
          province,
          district,
          ward,
          hamlet: document.getElementById('hamlet').value.trim(),
          referral: document.referrer || '',
          device: navigator.userAgent || '',
          extra: extra
        };

        submitBtn.disabled = true;
        submitText.innerHTML = '<span class="spinner"></span> Đang gửi...';
        statusEl.style.color = '#6b7280';
        statusEl.textContent = 'Đang gửi dữ liệu...';

        try {
          const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify(data),
            headers: { 'Content-Type': 'text/plain' }
          });

          const result = await response.json();

          if (result.success) {
            statusEl.style.color = '#15803d';
            statusEl.textContent = result.message;
            submitText.textContent = 'Đã gửi';
          } else {
            throw new Error(result.message);
          }
        } catch (err) {
          statusEl.style.color = '#b91c1c';
          statusEl.textContent = 'Lỗi: ' + err.message;
          submitText.textContent = 'Gửi lại';
        } finally {
          submitBtn.disabled = false;
        }
      });
    }
  </script>
</body>
</html>
