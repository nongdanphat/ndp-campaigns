<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>N√¥ng D√¢n Ph√°t ‚Äì Webform Campaign</title>

  <!--
    H∆Ø·ªöNG D·∫™N NHANH
    - ƒê·∫∑t file n√†y l√™n Cloudflare Pages (th∆∞ m·ª•c public).
    - ƒê·ªïi GAS_URL b√™n d∆∞·ªõi th√†nh URL Web App c·ªßa Google Apps Script (Deploy Web App, Anyone).
    - ƒê·∫∑t administrative-unit-data.json ·ªü /assets/ (c√πng site), ho·∫∑c s·ª≠a ADMIN_JSON_URL cho ph√π h·ª£p.
    - Truy·ªÅn ?campaign_id=... tr√™n URL ƒë·ªÉ tr·ªè v·ªÅ campaign t∆∞∆°ng ·ª©ng.
    - Ng∆∞·ªùi d√πng ƒë∆∞·ª£c ph√©p submit nhi·ªÅu l·∫ßn. Sau khi submit xong, form ·∫©n ƒëi, hi·ªÉn th·ªã bi√™n nh·∫≠n v√† c√≥ n√∫t "G·ª≠i th√¥ng tin kh√°c".
  -->

  <style>
    :root{--bg:#f3f4f6;--card:#fff;--primary:#15803d;--danger:#b91c1c;--muted:#6b7280;--radius:16px;--shadow:0 10px 30px rgba(15,23,42,.08)}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background:var(--bg);color:#0f172a}
    .page{max-width:760px;margin:0 auto;padding:1rem 1rem 3rem}
    .hero{background:linear-gradient(135deg,#ecfdf3 0%,#fff 100%);border-radius:20px;padding:1rem;margin:1rem 0;display:flex;gap:1rem;align-items:center}
    .hero img{width:90px;height:90px;border-radius:14px;object-fit:cover}
    .hero-title{font-weight:700;font-size:1.1rem;margin-bottom:.25rem}
    .hero-desc{color:#475569;font-size:.9rem;margin:0}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:1.25rem;margin-top:1rem}
    .form-title{font-weight:600;margin:1rem 0 .5rem}
    .field{margin-bottom:.75rem}
    .field label{display:block;font-weight:500;margin-bottom:.25rem}
    input,select,textarea{width:100%;padding:.55rem .6rem;border:1px solid #e2e8f0;border-radius:12px;font-size:.95rem;outline:0;transition:all .2s;background:#fff}
    input:focus,select:focus,textarea:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(21,128,61,.12)}
    input.error,select.error,textarea.error{border-color:var(--danger);background:#fee2e2}
    label.error-label{color:var(--danger);font-weight:600}
    button{background:var(--primary);color:#fff;border:0;border-radius:999px;padding:.65rem 1rem;font-weight:700;width:100%;cursor:pointer;transition:filter .2s}
    button:hover{filter:brightness(.95)}
    .muted{color:#64748b;font-size:.9rem}
    .status{margin-top:.6rem;font-size:.9rem;min-height:1.25rem}
    .spinner{width:14px;height:14px;border:2px solid rgba(255,255,255,.45);border-top-color:#fff;border-radius:999px;display:inline-block;animation:spin .6s linear infinite;margin-right:.35rem;vertical-align:-2px}
    @keyframes spin{to{transform:rotate(360deg)}}
    @media (max-width:640px){.hero img{display:none}}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:.75rem}
    @media (max-width:640px){.row{grid-template-columns:1fr}}
    ul.clean{margin:.25rem 0 0;padding-left:1rem}
  </style>
</head>
<body>
  <div class="page">
    <div class="hero" id="campaignHero">
      <img id="campaignImage" src="https://dummyimage.com/160x160/16a34a/ffffff&text=NDP" alt="Chi·∫øn d·ªãch" />
      <div>
        <div class="hero-title" id="campaignTitle">Chi·∫øn d·ªãch N√¥ng D√¢n Ph√°t</div>
        <p class="hero-desc" id="campaignDesc">Vui l√≤ng ƒëi·ªÅn th√¥ng tin ch√≠nh x√°c ƒë·ªÉ NDP k·∫øt n·ªëi v√† h·ªó tr·ª£ b·∫°n t·ªët h∆°n.</p>
      </div>
    </div>

    <!-- FORM CARD -->
    <div class="card" id="formCard">
      <div class="form-title">Th√¥ng tin c∆° b·∫£n</div>
      <div class="field">
        <label for="full_name">H·ªç v√† t√™n *</label>
        <input type="text" id="full_name" placeholder="VD: Nguy·ªÖn VƒÉn A" required>
      </div>
      <div class="field">
        <label for="phone">S·ªë ƒëi·ªán tho·∫°i *</label>
        <input type="tel" id="phone" placeholder="VD: 0912 345 678" required>
      </div>

      <div class="form-title">ƒê·ªãa ch·ªâ</div>
      <div class="row">
        <div class="field">
          <label for="province">T·ªânh / Th√†nh ph·ªë *</label>
          <select id="province" required><option value="">-- Ch·ªçn --</option></select>
        </div>
        <div class="field">
          <label for="district">Huy·ªán / Th·ªã x√£ / TP tr·ª±c thu·ªôc *</label>
          <select id="district" required><option value="">-- Ch·ªçn --</option></select>
        </div>
      </div>
      <div class="row">
        <div class="field">
          <label for="ward">X√£ / Ph∆∞·ªùng / Th·ªã tr·∫•n *</label>
          <select id="ward" required><option value="">-- Ch·ªçn --</option></select>
        </div>
        <div class="field">
          <label for="hamlet">Th√¥n / ·∫§p / T·ªï d√¢n ph·ªë *</label>
          <input type="text" id="hamlet" placeholder="VD: Th√¥n Ph√∫ Long / ·∫§p T√¢n Hi·ªáp 2 / T·ªï 5 KP 3" required>
        </div>
      </div>

      <!-- V√ôNG TR∆Ø·ªúNG T√ôY BI·∫æN THEO CHI·∫æN D·ªäCH (n·∫øu c√≥) -->
      <div id="customFields"></div>

      <div class="muted">Tr∆∞·ªùng c√≥ d·∫•u * l√† b·∫Øt bu·ªôc.</div>
      <button id="submitBtn"><span id="submitText">G·ª≠i th√¥ng tin</span></button>
      <div id="status" class="status"></div>
    </div>

    <!-- RESULT CARD -->
    <div class="card" id="resultCard" style="display:none">
      <div class="form-title">üéâ ƒê√£ nh·∫≠n th√¥ng tin</div>
      <div id="receipt" class="muted"></div>
      <button id="newSubmitBtn" style="margin-top:.75rem">G·ª≠i th√¥ng tin kh√°c</button>
    </div>

    <div class="muted" style="margin-top:1rem">
      Tip: truy·ªÅn <code>?campaign_id=...</code> tr√™n URL ƒë·ªÉ ƒë·ªãnh danh chi·∫øn d·ªãch.
    </div>
  </div>

  <script>
    // ======= C·∫§U H√åNH C∆† B·∫¢N =======
    // ƒê·ªîI URL n√†y th√†nh Web App URL c·ªßa Google Apps Script (Deploy Web app, Anyone).
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxIDU6L5XQNziOdgYUNJkRQoX6Zubn4bbVUHdAabkud-fQWy-LMtKHBsEoBd83NpyrMbA/exec";

    // ƒê∆∞·ªùng d·∫´n JSON ƒë·ªãa gi·ªõi h√†nh ch√≠nh (ƒë·∫∑t c√πng site ƒë·ªÉ cache t·ªët).
    const ADMIN_JSON_URL = "/public/assets/administrative-unit-data.json";

    // Campaign default n·∫øu kh√¥ng truy·ªÅn ?campaign_id=
    const DEFAULT_CAMPAIGN_ID = "NDP_CAMPAIGN_01";

    // ======= TR·ª¢ GI√öP =======
    const $ = (id) => document.getElementById(id);
    const provinceEl = $("province");
    const districtEl = $("district");
    const wardEl = $("ward");
    const statusEl = $("status");
    const submitBtn = $("submitBtn");
    const submitText = $("submitText");

    let isSubmitting = false;
    let ADMIN_DATA = [];
    let districtsByProvince = {};
    let wardsByDistrict = {};

    function urlCampaignId() {
      const u = new URL(window.location.href);
      return u.searchParams.get("campaign_id") || "";
    }
    function clearSelect(sel, placeholder) {
      sel.innerHTML = "";
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = placeholder;
      sel.appendChild(opt);
    }
    function fillSelect(sel, list) {
      clearSelect(sel, "-- Ch·ªçn --");
      (list || []).forEach((x) => {
        const o = document.createElement("option");
        o.value = String(x.code);
        o.textContent = x.name;
        sel.appendChild(o);
      });
    }
    function buildIndexes(data) {
      districtsByProvince = {};
      wardsByDistrict = {};
      data.forEach((p) => {
        districtsByProvince[String(p.code)] = p.districts || [];
        (p.districts || []).forEach((d) => {
          wardsByDistrict[String(d.code)] = d.wards || [];
        });
      });
    }
    function setStatus(msg, color="#64748b") {
      statusEl.style.color = color;
      statusEl.textContent = msg || "";
    }
    function markRequiredError(ids) {
      let first = null;
      ids.forEach((id) => {
        const el = $(id);
        const label = el?.previousElementSibling;
        const isEmpty = !String(el?.value || "").trim();
        el?.classList.toggle("error", isEmpty);
        label?.classList.toggle("error-label", isEmpty);
        if (isEmpty && !first) first = el;
      });
      if (first) first.focus();
      return !first;
    }
    function findName(arr, code) {
      const s = String(code || "");
      const f = (arr || []).find((x) => String(x.code) === s);
      return f ? f.name : "";
    }

    function renderReceipt(data, serverTimeISO) {
      const lines = [
        ["Chi·∫øn d·ªãch", data.campaign_id],
        ["H·ªç v√† t√™n", data.full_name],
        ["S·ªë ƒëi·ªán tho·∫°i", data.phone],
        ["T·ªânh/TP", data.province],
        ["Huy·ªán/Th·ªã x√£/TP", data.district],
        ["X√£/Ph∆∞·ªùng/Th·ªã tr·∫•n", data.ward],
        ["Th√¥n/·∫§p/T·ªï d√¢n ph·ªë", data.hamlet],
        ["Ngu·ªìn (referrer)", data.referral],
        ["Thi·∫øt b·ªã", data.device],
        ["Th·ªùi ƒëi·ªÉm ghi (server)", new Date(serverTimeISO || Date.now()).toLocaleString("vi-VN")]
      ];
      const extra = Object.keys(data).filter(k => ![
        "campaign_id","full_name","phone","province","district","ward","hamlet","referral","device"
      ].includes(k));
      const wrap = $("receipt");
      wrap.innerHTML = `
        <ul class="clean">
          ${lines.map(([k,v]) => `<li><b>${k}:</b> ${v ?? ""}</li>`).join("")}
          ${extra.length ? `<li><b>Tr∆∞·ªùng b·ªï sung:</b>
            <ul class="clean">${extra.map(k => `<li><b>${k}:</b> ${data[k] ?? ""}</li>`).join("")}</ul>
          </li>` : ""}
        </ul>
      `;
    }
    function showResultCard() {
      $("formCard").style.display = "none";
      $("resultCard").style.display = "block";
    }
    function showFormCard() {
      $("formCard").style.display = "block";
      $("resultCard").style.display = "none";
    }

    // ======= KH·ªûI T·∫†O =======
    (async function init() {
      try {
        // Load admin JSON
        const res = await fetch(ADMIN_JSON_URL, { cache: "force-cache" });
        ADMIN_DATA = await res.json();
        buildIndexes(ADMIN_DATA);
        fillSelect(provinceEl, ADMIN_DATA);

        provinceEl.addEventListener("change", () => {
          fillSelect(districtEl, districtsByProvince[provinceEl.value]);
          clearSelect(wardEl, "-- Ch·ªçn --");
        });
        districtEl.addEventListener("change", () => {
          fillSelect(wardEl, wardsByDistrict[districtEl.value]);
        });

        // Campaign UI (t√πy ch·ªânh c∆° b·∫£n qua query n·∫øu mu·ªën)
        const cid = urlCampaignId() || DEFAULT_CAMPAIGN_ID;
        $("campaignTitle").textContent = "Chi·∫øn d·ªãch " + cid;
        $("campaignDesc").textContent = "Vui l√≤ng ƒëi·ªÅn th√¥ng tin ch√≠nh x√°c cho " + cid + " ƒë·ªÉ NDP h·ªó tr·ª£ b·∫°n t·ªët h∆°n.";
      } catch (e) {
        console.error(e);
        setStatus("Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu ƒë∆°n v·ªã h√†nh ch√≠nh. Vui l√≤ng th·ª≠ l·∫°i.", "#b91c1c");
      }
    })();

    // ======= SUBMIT =======
    submitBtn.addEventListener("click", async () => {
      if (isSubmitting) return;
      const ok = markRequiredError(["full_name","phone","province","district","ward","hamlet"]);
      if (!ok) { setStatus("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß c√°c tr∆∞·ªùng b·∫Øt bu·ªôc (ƒë√°nh d·∫•u ƒë·ªè).", "#b91c1c"); return; }

      isSubmitting = true;
      submitBtn.disabled = true;
      submitText.innerHTML = '<span class="spinner"></span> ƒêang g·ª≠i...';
      setStatus("ƒêang g·ª≠i d·ªØ li·ªáu...");

      const province = findName(ADMIN_DATA, provinceEl.value);
      const district = findName(districtsByProvince[provinceEl.value], districtEl.value);
      const ward = findName(wardsByDistrict[districtEl.value], wardEl.value);

      const payload = {
        campaign_id: urlCampaignId() || DEFAULT_CAMPAIGN_ID,
        full_name: $("full_name").value.trim(),
        phone: $("phone").value.trim(),
        province, district, ward,
        hamlet: $("hamlet").value.trim(),
        referral: document.referrer || "",
        device: navigator.userAgent || "N/A"
        // Th√™m tr∆∞·ªùng t√πy bi·∫øn ·ªü ƒë√¢y n·∫øu campaign c√≥ (v√≠ d·ª•):
        // , crop_type: $("crop_type")?.value || ""
      };

      try {
        const resp = await fetch(GAS_URL, {
          method: "POST",
          headers: { "Content-Type": "text/plain" }, // simple request -> tr√°nh preflight
          body: JSON.stringify(payload)
        });
        const data = await resp.json().catch(() => ({}));
        if (resp.ok && data?.success) {
          setStatus("");
          submitText.textContent = "ƒê√£ g·ª≠i ‚úî";
          renderReceipt(data.echo || payload, data.submitted_at_iso);
          showResultCard();
        } else {
          setStatus(data?.message || "C√≥ l·ªói khi g·ª≠i.", "#b91c1c");
          submitText.textContent = "G·ª≠i l·∫°i";
          submitBtn.disabled = false;
          isSubmitting = false;
        }
      } catch (err) {
        console.error(err);
        setStatus("L·ªói m·∫°ng ho·∫∑c server. Vui l√≤ng th·ª≠ l·∫°i.", "#b91c1c");
        submitText.textContent = "G·ª≠i l·∫°i";
        submitBtn.disabled = false;
        isSubmitting = false;
      }
    });

    // G·ª≠i th√¥ng tin kh√°c: reset form
    $("newSubmitBtn").addEventListener("click", () => {
      ["full_name","phone","hamlet"].forEach(id => { const el = $(id); if (el) el.value=""; });
      clearSelect(districtEl, "-- Ch·ªçn --");
      clearSelect(wardEl, "-- Ch·ªçn --");
      provinceEl.value = "";
      setStatus("");
      submitText.textContent = "G·ª≠i th√¥ng tin";
      submitBtn.disabled = false;
      isSubmitting = false;
      showFormCard();
      window.scrollTo({ top: 0, behavior: "smooth" });
    });
  </script>
</body>
</html>
